name: Deploy SAARCISinistres

on:
  workflow_run:
    workflows: ["Tests SAARCISinistres"]
    types: [completed]
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            # Configuration
            PROJECT_DIR="/var/www/sinistres.saarassurancesci.com/saarsinistre"
            
            # Sauvegarder les fichiers critiques
            echo "üîÑ Sauvegarde des fichiers critiques..."
            sudo -u www-data cp $PROJECT_DIR/.env $PROJECT_DIR/.env.backup
            sudo -u www-data cp -r $PROJECT_DIR/storage $PROJECT_DIR/storage.backup
            
            # Mettre √† jour le code
            echo "üì• Mise √† jour du code..."
            cd $PROJECT_DIR
            sudo -u www-data git config --global --add safe.directory $PROJECT_DIR
            sudo -u www-data git fetch origin
            sudo -u www-data git reset --hard origin/main
            
            # Installer les d√©pendances
            echo "üì¶ Installation des d√©pendances..."
            sudo -u www-data composer install --no-dev --optimize-autoloader
            sudo -u www-data npm ci --cache /tmp/.npm
            sudo -u www-data npm run build
            
            # Ex√©cuter les migrations
            echo "üóÑÔ∏è Ex√©cution des migrations..."
            sudo -u www-data php artisan migrate --force
            
            # Optimiser l'application
            echo "‚ö° Optimisation de l'application..."
            sudo -u www-data php artisan config:cache
            sudo -u www-data php artisan route:cache
            sudo -u www-data php artisan view:cache
            
            # Red√©marrer les services
            echo "üîÑ Red√©marrage des services..."
            sudo systemctl reload nginx
            sudo systemctl reload php8.4-fpm
            
            echo "üéâ D√©ploiement termin√© avec succ√®s !"
        
      - name: Health Check
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            # V√©rifier que l'application r√©pond
            echo "üîç V√©rification de l'application..."
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://sinistres.saarassurancesci.com)
            
            if [ "$HTTP_STATUS" = "200" ]; then
              echo "‚úÖ Application accessible (HTTP $HTTP_STATUS)"
            else
              echo "‚ùå Application non accessible (HTTP $HTTP_STATUS)"
              echo "üîÑ Tentative de rollback..."
              
              # Rollback simple avec Git
              cd $PROJECT_DIR
              sudo -u www-data git reset --hard HEAD~1
              sudo -u www-data php artisan config:cache
              sudo -u www-data php artisan route:cache
              sudo -u www-data php artisan view:cache
              sudo systemctl reload nginx
              sudo systemctl reload php8.4-fpm
              echo "‚úÖ Rollback termin√©"
              
              exit 1
            fi
